<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Data Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .buffer-calc {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .buffer-calc label {
            margin-right: 10px;
        }

        input[type="file"],
        input[type="number"],
        button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .ath-label {
            color: #333;
        }

        #athValueInput {
            width: 80px;
        }

        #baseBufferInput, #kInput {
            width: 60px;
        }

        .calc-display {
            font-size: 0.9em;
            color: #444;
        }

        .calc-display table {
            width: 100%;
            border-collapse: collapse;
        }

        .calc-display td {
            padding: 5px;
            border: 1px solid transparent; /* Transparent borders */
            vertical-align: top;
        }

        .matching-rows-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .matching-rows {
            font-size: 0.9em;
            color: #444;
            width: 48%;
            min-width: 300px;
        }

        .matching-rows table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .matching-rows th, .matching-rows td {
            padding: 5px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .matching-rows th {
            background-color: #f8f9fa;
            color: #333;
        }

        table {
            width: 45%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 20px;
            display: inline-block;
            vertical-align: top;
            font-size: 0.9em;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            color: #333;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .no-data {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .day-section {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: nowrap;
        }

        .day-header 
   
{
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            margin-bottom: 5px;
            font-size: 1.1em;
            color: #444;
        }

        .highlight-row {
            background-color: #e6eaef;
        }

        .table-wrapper {
            width: 48%;
        }

        .high-yield-strike {
            outline: 2px solid red;
            outline-offset: -1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="pageTitle">CSV Data Viewer</h1>
        <div class="controls">
            <input type="file" id="csvFile" accept=".csv">
            <button onclick="processCSV()">Process CSV</button>
            <input type="number" id="strikeRelInput" placeholder="Strike Rel Threshold (%)" step="0.1">
            <input type="number" id="yieldInput" placeholder="Yield Threshold (%)" value="2.5" step="0.1">
            <button onclick="highlightRows()">Highlight</button>
            <span id="athLabel" class="ath-label">xxx ATH :</span>
            <input type="number" id="athValueInput" value="Unknown" step="0.01" onchange="updateBufferCalc()">
        </div>
        <div class="buffer-calc">
            <div>
                <label>Base Buffer (%):</label>
                <input type="number" id="baseBufferInput" value="20" step="0.1" onchange="updateBufferCalc()">
                <label>k:</label>
                <input type="number" id="kInput" value="1" step="0.1" onchange="updateBufferCalc()">
                <div id="calcDisplay" class="calc-display">
                    <table>
                        <tr><td>Current Price</td><td>N/A</td><td></td></tr>
                        <tr><td>Price-to-ATH Ratio</td><td>N/A</td><td></td></tr>
                        <tr><td>Buffer Percentage</td><td>N/A</td><td></td></tr>
                        <tr><td>Strike</td><td>N/A</td><td></td></tr>
                    </table>
                </div>
            </div>
            <div class="matching-rows-container">
                <div id="coveredCalls" class="matching-rows">
                    <strong>Covered Calls:</strong>
                    <table>
                        <thead>
                            <tr><th>Days</th><th>Stock</th><th>Strike</th><th>Strike Rel</th><th>Premium</th><th>Yield</th></tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6">No matches yet</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="securedPuts" class="matching-rows">
                    <strong>Secured Puts:</strong>
                    <table>
                        <thead>
                            <tr><th>Days</th><th>Stock</th><th>Strike</th><th>Strike Rel</th><th>Premium</th><th>Yield</th></tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6">No matches yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="tableContainer"></div>
    </div>

    <script>
        let csvData = [];
        let currentStockSymbol = '';
        let currentPrice = null;

        // Predefined ATH values for specific stocks
        const athValues = {
            'TQQQ': '99.90',
            'PLTR': '125.41',
            'TSLA': '497.91',
            'NVDA': '148.87',
            'MSTR': '440'  // Added ATH for MSTR
        };

        function processCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first');
                return;
            }

            const filename = file.name;
            const underscoreIndex = filename.indexOf('_');
            if (underscoreIndex !== -1) {
                currentStockSymbol = filename.substring(0, underscoreIndex).toUpperCase();
            } else {
                currentStockSymbol = filename.split('.')[0].toUpperCase();
            }
            
            document.getElementById('pageTitle').textContent = `${currentStockSymbol} Option Chains`;
            updateATHDisplay(currentStockSymbol);

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                csvData = parseCSV(text);
                displayTable(csvData);
                updateBufferCalc();
            };
            reader.readAsText(file);
        }

        function updateATHDisplay(symbol) {
            const athLabel = document.getElementById('athLabel');
            const athValueInput = document.getElementById('athValueInput');
            athLabel.textContent = `${symbol} ATH :`;
            
            if (athValues.hasOwnProperty(symbol)) {
                athValueInput.value = athValues[symbol];
            } else {
                athValueInput.value = 'Unknown';
            }
        }

        function updateBufferCalc() {
            const athValue = parseFloat(document.getElementById('athValueInput').value);
            const baseBuffer = parseFloat(document.getElementById('baseBufferInput').value) / 100; // Convert to decimal
            const k = parseFloat(document.getElementById('kInput').value);
            const calcDisplay = document.getElementById('calcDisplay');
            const strikeRelInput = document.getElementById('strikeRelInput');

            if (!csvData.length || isNaN(athValue) || isNaN(baseBuffer) || isNaN(k)) {
                calcDisplay.innerHTML = `
                    <table>
                        <tr><td>Current Price</td><td>N/A</td><td></td></tr>
                        <tr><td>Price-to-ATH Ratio</td><td>N/A</td><td></td></tr>
                        <tr><td>Buffer Percentage</td><td>N/A</td><td></td></tr>
                        <tr><td>Strike</td><td>N/A</td><td></td></tr>
                    </table>
                `;
                strikeRelInput.value = ''; // Clear Strike Rel Threshold
                return;
            }

            // Get current price from the first row of CSV data (assuming "stock" column)
            currentPrice = parseFloat(csvData[0].stock);
            if (isNaN(currentPrice)) {
                calcDisplay.innerHTML = `
                    <table>
                        <tr><td>Current Price</td><td>N/A (Missing stock price in CSV)</td><td></td></tr>
                        <tr><td>Price-to-ATH Ratio</td><td>N/A</td><td></td></tr>
                        <tr><td>Buffer Percentage</td><td>N/A</td><td></td></tr>
                        <tr><td>Strike</td><td>N/A</td><td></td></tr>
                    </table>
                `;
                strikeRelInput.value = ''; // Clear Strike Rel Threshold
                return;
            }

            // Calculate buffer and strike
            const priceToATHRatio = currentPrice / athValue;
            const bufferPercentage = baseBuffer * Math.pow(priceToATHRatio, k);
            const strike = currentPrice * (1 - bufferPercentage);

            // Pre-fill Strike Rel Threshold with Buffer Percentage
            strikeRelInput.value = (bufferPercentage * 100).toFixed(2);

            // Update display with calculated values in a 4x3 table, bolding Buffer Percentage and Strike
            calcDisplay.innerHTML = `
                <table>
                    <tr><td>Current Price</td><td>$${currentPrice.toFixed(2)}</td><td></td></tr>
                    <tr><td>Price-to-ATH Ratio</td><td>${priceToATHRatio.toFixed(2)}</td><td>$${currentPrice.toFixed(2)} / $${athValue.toFixed(2)}</td></tr>
                    <tr><td>Buffer Percentage</td><td><strong>${(bufferPercentage * 100).toFixed(2)}%</strong></td><td>${(baseBuffer * 100).toFixed(2)}% × ${priceToATHRatio.toFixed(2)}^${k}</td></tr>
                    <tr><td>Strike</td><td><strong>$${strike.toFixed(2)}</strong></td><td>$${currentPrice.toFixed(2)} × (1 - ${bufferPercentage.toFixed(2)})</td></tr>
                </table>
            `;
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 1) return [];

            const allHeaders = parseCSVLine(lines[0]);
            const headerIndices = {};
            allHeaders.forEach((header, index) => {
                headerIndices[header] = index;
            });

            const validHeaders = allHeaders.filter(header => 
                header.trim() !== '' && 
                header.toLowerCase() !== 'multiplier' && 
                header.toLowerCase() !== 'type'
            );

            if (!validHeaders.includes('days')) {
                alert('CSV file must contain a "days" column');
                return;
            }

            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= validHeaders.length) {
                    const obj = {};
                    validHeaders.forEach((header) => {
                        const index = headerIndices[header];
                        obj[header] = values[index] || '';
                    });
                    obj.type = values[headerIndices['type']] || '';
                    result.push(obj);
                }
            }
            return result.sort((a, b) => parseFloat(a.days) - parseFloat(b.days));
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let char of line.trim()) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(value => value.replace(/^"|"$/g, '').trim());
        }

        function displayTable(data) {
            if (data.length === 0) {
                document.getElementById('tableContainer').innerHTML = 
                    '<p class="no-data">No data to display</p>';
                return;
            }

            const headers = Object.keys(data[0]).filter(header => header !== 'type');
            let html = '';

            const daysGroups = {};
            data.forEach(row => {
                if (!daysGroups[row.days]) {
                    daysGroups[row.days] = { C: [], P: [] };
                }
                if (row.type === 'C') {
                    daysGroups[row.days].C.push(row);
                } else if (row.type === 'P') {
                    daysGroups[row.days].P.push(row);
                }
            });

            Object.keys(daysGroups).forEach(day => {
                const group = daysGroups[day];
                html += '<div class="day-section">';

                if (group.C.length > 0) {
                    html += `<div class="table-wrapper">`;
                    html += `<div class="day-header">${day} Day(s) - Covered Calls</div>`;
                    html += '<table><thead><tr>';
                    headers.forEach(header => {
                        html += `<th>${header}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    group.C.forEach(row => {
                        const shouldHighlight = row.strike && row.stock && 
                            parseFloat(row.strike) < parseFloat(row.stock);
                        let classNames = shouldHighlight ? ['highlight-row'] : [];
                        html += `<tr${classNames.length ? ' class="' + classNames.join(' ') + '"' : ''}>`;
                        headers.forEach(header => {
                            let displayValue = row[header] || '';
                            if (header.toLowerCase() === 'stock' && displayValue !== '') {
                                const parsedValue = parseFloat(displayValue);
                                displayValue = isNaN(parsedValue) ? displayValue : parsedValue.toFixed(2);
                            }
                            html += `<td>${displayValue}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                }

                if (group.P.length > 0) {
                    html += `<div class="table-wrapper">`;
                    html += `<div class="day-header">${day} Day(s) - Secured Puts</div>`;
                    html += '<table><thead><tr>';
                    headers.forEach(header => {
                        html += `<th>${header}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    group.P.forEach(row => {
                        const shouldHighlight = row.strike && row.stock && 
                            parseFloat(row.strike) > parseFloat(row.stock);
                        let classNames = shouldHighlight ? ['highlight-row'] : [];
                        html += `<tr${classNames.length ? ' class="' + classNames.join(' ') + '"' : ''}>`;
                        headers.forEach(header => {
                            let displayValue = row[header] || '';
                            if (header.toLowerCase() === 'stock' && displayValue !== '') {
                                const parsedValue = parseFloat(displayValue);
                                displayValue = isNaN(parsedValue) ? displayValue : parsedValue.toFixed(2);
                            }
                            html += `<td>${displayValue}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                }

                html += '</div>';
            });

            document.getElementById('tableContainer').innerHTML = html;
        }

        function highlightRows() {
            const strikeRelThreshold = parseFloat(document.getElementById('strikeRelInput').value);
            const yieldThreshold = parseFloat(document.getElementById('yieldInput').value);
            const coveredCallsDisplay = document.getElementById('coveredCalls');
            const securedPutsDisplay = document.getElementById('securedPuts');

            if (isNaN(strikeRelThreshold) || isNaN(yieldThreshold)) {
                alert('Please enter valid numbers for Strike Rel and Yield thresholds');
                return;
            }

            if (csvData.length === 0) {
                alert('Please process a CSV file first');
                return;
            }

            const headers = Object.keys(csvData[0]).filter(header => header !== 'type');
            let html = '';
            let coveredCallsHtml = '<strong>Covered Calls:</strong><table><thead><tr><th>Days</th><th>Stock</th><th>Strike</th><th>Strike Rel</th><th>Premium</th><th>Yield</th></tr></thead><tbody>';
            let securedPutsHtml = '<strong>Secured Puts:</strong><table><thead><tr><th>Days</th><th>Stock</th><th>Strike</th><th>Strike Rel</th><th>Premium</th><th>Yield</th></tr></thead><tbody>';
            let coveredCalls = [];
            let securedPuts = [];

            const daysGroups = {};
            csvData.forEach(row => {
                if (!daysGroups[row.days]) {
                    daysGroups[row.days] = { C: [], P: [] };
                }
                if (row.type === 'C') {
                    daysGroups[row.days].C.push(row);
                } else if (row.type === 'P') {
                    daysGroups[row.days].P.push(row);
                }
            });

            Object.keys(daysGroups).forEach(day => {
                const group = daysGroups[day];
                html += '<div class="day-section">';

                if (group.C.length > 0) {
                    html += `<div class="table-wrapper">`;
                    html += `<div class="day-header">${day} Day(s) - Covered Calls</div>`;
                    html += '<table><thead><tr>';
                    headers.forEach(header => {
                        html += `<th>${header}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    group.C.forEach(row => {
                        const shouldHighlight = row.strike && row.stock && 
                            parseFloat(row.strike) < parseFloat(row.stock);
                        const highYieldStrike = row.strike_rel && row.yield && 
                            parseFloat(row.strike_rel) >= strikeRelThreshold && 
                            parseFloat(row.yield) >= yieldThreshold;
                        let classNames = [];
                        if (shouldHighlight) classNames.push('highlight-row');
                        if (highYieldStrike) {
                            classNames.push('high-yield-strike');
                            coveredCalls.push({
                                days: row.days,
                                stock: row.stock,
                                strike: row.strike,
                                strike_rel: row.strike_rel,
                                premium: row.premium,
                                yield: row.yield
                            });
                        }
                        html += `<tr${classNames.length ? ' class="' + classNames.join(' ') + '"' : ''}>`;
                        headers.forEach(header => {
                            let displayValue = row[header] || '';
                            if (header.toLowerCase() === 'stock' && displayValue !== '') {
                                const parsedValue = parseFloat(displayValue);
                                displayValue = isNaN(parsedValue) ? displayValue : parsedValue.toFixed(2);
                            }
                            html += `<td>${displayValue}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                }

                if (group.P.length > 0) {
                    html += `<div class="table-wrapper">`;
                    html += `<div class="day-header">${day} Day(s) - Secured Puts</div>`;
                    html += '<table><thead><tr>';
                    headers.forEach(header => {
                        html += `<th>${header}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    group.P.forEach(row => {
                        const shouldHighlight = row.strike && row.stock && 
                            parseFloat(row.strike) > parseFloat(row.stock);
                        const highYieldStrike = row.strike_rel && row.yield && 
                            parseFloat(row.strike_rel) <= -strikeRelThreshold && 
                            parseFloat(row.yield) >= yieldThreshold;
                        let classNames = [];
                        if (shouldHighlight) classNames.push('highlight-row');
                        if (highYieldStrike) {
                            classNames.push('high-yield-strike');
                            securedPuts.push({
                                days: row.days,
                                stock: row.stock,
                                strike: row.strike,
                                strike_rel: row.strike_rel,
                                premium: row.premium,
                                yield: row.yield
                            });
                        }
                        html += `<tr${classNames.length ? ' class="' + classNames.join(' ') + '"' : ''}>`;
                        headers.forEach(header => {
                            let displayValue = row[header] || '';
                            if (header.toLowerCase() === 'stock' && displayValue !== '') {
                                const parsedValue = parseFloat(displayValue);
                                displayValue = isNaN(parsedValue) ? displayValue : parsedValue.toFixed(2);
                            }
                            html += `<td>${displayValue}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                }

                html += '</div>';
            });

            // Update Covered Calls table
            if (coveredCalls.length === 0) {
                coveredCallsHtml += '<tr><td colspan="6">No matches found</td></tr>';
            } else {
                coveredCalls.forEach(row => {
                    coveredCallsHtml += `
                        <tr>
                            <td>${row.days}</td>
                            <td>${parseFloat(row.stock).toFixed(2)}</td>
                            <td>${row.strike}</td>
                            <td>${row.strike_rel}</td>
                            <td>${row.premium}</td>
                            <td>${row.yield}</td>
                        </tr>
                    `;
                });
            }
            coveredCallsHtml += '</tbody></table>';
            coveredCallsDisplay.innerHTML = coveredCallsHtml;

            // Update Secured Puts table
            if (securedPuts.length === 0) {
                securedPutsHtml += '<tr><td colspan="6">No matches found</td></tr>';
            } else {
                securedPuts.forEach(row => {
                    securedPutsHtml += `
                        <tr>
                            <td>${row.days}</td>
                            <td>${parseFloat(row.stock).toFixed(2)}</td>
                            <td>${row.strike}</td>
                            <td>${row.strike_rel}</td>
                            <td>${row.premium}</td>
                            <td>${row.yield}</td>
                        </tr>
                    `;
                });
            }
            securedPutsHtml += '</tbody></table>';
            securedPutsDisplay.innerHTML = securedPutsHtml;

            document.getElementById('tableContainer').innerHTML = html;
        }
    </script>
</body>
</html>
